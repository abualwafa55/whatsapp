generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum SessionStatus {
  CREATING
  CONNECTING
  CONNECTED
  DISCONNECTED
  GENERATING_QR
}

enum CampaignStatus {
  DRAFT
  READY
  SCHEDULED
  RUNNING
  SENDING
  PAUSED
  COMPLETED
  CANCELLED
  FAILED
}

enum CampaignRecipientStatus {
  PENDING
  SENT
  FAILED
}

model User {
  id           String      @id @default(uuid()) @db.Char(36)
  email        String      @unique @db.VarChar(191)
  passwordHash String      @map("password_hash") @db.VarChar(255)
  role         UserRole    @default(USER)
  createdBy    String?     @map("created_by") @db.VarChar(191)
  createdAt    DateTime    @default(now()) @map("created_at")
  lastLogin    DateTime?   @map("last_login")
  isActive     Boolean     @default(true) @map("is_active")

  sessions       Session[]
  recipientLists RecipientList[]
  campaigns      Campaign[]
  activityLogs   ActivityLog[]
}

model Session {
  id        String        @id @default(uuid()) @db.Char(36)
  name      String?       @db.VarChar(191)
  status    SessionStatus @default(CREATING)
  detail    String?       @db.VarChar(512)
  qr        String?       @db.Text
  reason    String?       @db.VarChar(512)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  ownerId String? @map("owner_id") @db.Char(36)
  owner   User?   @relation(fields: [ownerId], references: [id])

  tokens    SessionToken[]
  campaigns Campaign[]
}

model SessionToken {
  id         Int      @id @default(autoincrement())
  sessionId  String   @map("session_id") @db.Char(36) @unique
  tokenValue String   @map("token_value") @db.VarChar(191)
  expiresAt  DateTime? @map("expires_at")
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime @default(now()) @map("created_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model RecipientList {
  id          String     @id @default(uuid()) @db.VarChar(191)
  name        String     @db.VarChar(191)
  description String?    @db.Text
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime?  @map("updated_at")
  lastUsed    DateTime?  @map("last_used")
  usageCount  Int        @default(0) @map("usage_count")
  tags        Json?      @db.Json

  createdById    String? @map("created_by_id") @db.Char(36)
  createdByEmail String? @map("created_by_email") @db.VarChar(191)
  createdBy      User?   @relation(fields: [createdById], references: [id])

  recipients Recipient[]
}

model Recipient {
  id          Int           @id @default(autoincrement())
  listId      String        @map("list_id") @db.VarChar(191)
  number      String        @db.VarChar(20)
  name        String?       @db.VarChar(191)
  jobTitle    String?       @map("job_title") @db.VarChar(191)
  companyName String?       @map("company_name") @db.VarChar(191)
  customFields Json         @default("{}") @map("custom_fields")
  addedAt     DateTime      @default(now()) @map("added_at")

  list RecipientList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([listId])
  @@index([number])
}

model Campaign {
  id          String         @id @default(uuid()) @db.VarChar(191)
  name        String         @db.VarChar(191)
  status      CampaignStatus @default(DRAFT)
  scheduledAt DateTime?      @map("scheduled_at")
  startedAt   DateTime?      @map("started_at")
  completedAt DateTime?      @map("completed_at")
  message     Json           @map("message_payload")
  settings    Json           @map("settings_payload")
  statistics  Json?          @map("statistics_payload")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime?      @map("updated_at")

  createdById    String? @map("created_by_id") @db.Char(36)
  createdByEmail String? @map("created_by_email") @db.VarChar(191)
  createdBy      User?   @relation(fields: [createdById], references: [id])

  sessionId String?  @map("session_id") @db.Char(36)
  session   Session? @relation(fields: [sessionId], references: [id])

  recipients CampaignRecipient[]
}

model CampaignRecipient {
  id              Int                      @id @default(autoincrement())
  campaignId      String                   @map("campaign_id") @db.VarChar(191)
  recipientNumber String                   @map("recipient_number") @db.VarChar(20)
  payload         Json                     @map("payload")
  status          CampaignRecipientStatus  @default(PENDING)
  sentAt          DateTime?                @map("sent_at")
  error           String?                  @db.Text
  retryCount      Int                      @default(0) @map("retry_count")
  createdAt       DateTime                 @default(now()) @map("created_at")
  updatedAt       DateTime?                @map("updated_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([recipientNumber])
}

model ActivityLog {
  id           BigInt   @id @default(autoincrement())
  timestamp    DateTime @default(now())
  action       String   @db.VarChar(100)
  resourceType String?  @map("resource_type") @db.VarChar(64)
  resourceId   String?  @map("resource_id") @db.VarChar(128)
  details      Json?
  ip           String?  @db.VarChar(45)
  userAgent    String?  @map("user_agent") @db.VarChar(255)
  success      Boolean  @default(true)
  userEmail    String?  @map("user_email") @db.VarChar(191)

  userId String? @map("user_id") @db.Char(36)
  user   User?   @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resourceType, resourceId])
}
